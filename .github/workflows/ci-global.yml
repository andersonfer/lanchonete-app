name: CI - Global Validations

on:
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'services/clientes/**'
      - 'services/pedidos/**'
      - 'services/cozinha/**'
      - 'services/pagamento/**'

jobs:
  validate:
    name: Testes e AnÃ¡lise SonarCloud
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validar arquivos YAML/YML
        run: |
          echo "ðŸ” Validando arquivos YAML do Kubernetes..."

          # Verificar se hÃ¡ arquivos YAML modificados
          YAML_FILES=$(find k8s -name "*.yaml" -o -name "*.yml" 2>/dev/null || true)

          if [ -n "$YAML_FILES" ]; then
            echo "âœ… Encontrados arquivos YAML para validar"
            # ValidaÃ§Ã£o bÃ¡sica de sintaxe YAML
            for file in $YAML_FILES; do
              echo "  Validando: $file"
              # Verifica se o arquivo tem sintaxe vÃ¡lida usando Python
              python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>&1 || {
                echo "âŒ Erro de sintaxe em $file"
                exit 1
              }
            done
            echo "âœ… Todos os arquivos YAML sÃ£o vÃ¡lidos"
          else
            echo "â„¹ï¸  Nenhum arquivo YAML encontrado"
          fi

      - name: Validar arquivos Terraform
        run: |
          echo "ðŸ” Validando arquivos Terraform..."

          if [ -d "infra" ]; then
            # Verificar formataÃ§Ã£o do Terraform
            cd infra

            # Instalar Terraform se necessÃ¡rio
            if ! command -v terraform &> /dev/null; then
              echo "ðŸ“¥ Instalando Terraform..."
              wget -q https://releases.hashicorp.com/terraform/1.6.0/terraform_1.6.0_linux_amd64.zip
              unzip -q terraform_1.6.0_linux_amd64.zip
              sudo mv terraform /usr/local/bin/
            fi

            echo "ðŸ” Verificando formataÃ§Ã£o..."
            terraform fmt -check -recursive || {
              echo "âš ï¸  Arquivos Terraform nÃ£o estÃ£o formatados corretamente"
              echo "ðŸ’¡ Execute: terraform fmt -recursive"
              # NÃ£o falhar por formataÃ§Ã£o, apenas avisar
            }

            echo "âœ… ValidaÃ§Ã£o Terraform concluÃ­da"
          else
            echo "â„¹ï¸  DiretÃ³rio infra/ nÃ£o encontrado"
          fi

      - name: Validar estrutura de workflows
        run: |
          echo "ðŸ” Validando workflows do GitHub Actions..."

          if [ -d ".github/workflows" ]; then
            WORKFLOW_FILES=$(find .github/workflows -name "*.yml" -o -name "*.yaml" 2>/dev/null || true)

            for file in $WORKFLOW_FILES; do
              echo "  Validando: $file"
              python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>&1 || {
                echo "âŒ Erro de sintaxe em $file"
                exit 1
              }
            done
            echo "âœ… Todos os workflows sÃ£o vÃ¡lidos"
          fi

      - name: Validar scripts bash
        run: |
          echo "ðŸ” Validando scripts bash..."

          # Encontrar todos os scripts .sh
          SCRIPTS=$(find deploy_scripts test_scripts -name "*.sh" 2>/dev/null || true)

          if [ -n "$SCRIPTS" ]; then
            for script in $SCRIPTS; do
              echo "  Validando: $script"
              # Verificar sintaxe bash
              bash -n "$script" || {
                echo "âŒ Erro de sintaxe em $script"
                exit 1
              }
            done
            echo "âœ… Todos os scripts bash sÃ£o vÃ¡lidos"
          else
            echo "â„¹ï¸  Nenhum script bash encontrado"
          fi

      - name: Resumo da validaÃ§Ã£o
        if: success()
        run: |
          echo "## âœ… ValidaÃ§Ãµes Globais - Resumo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Todas as validaÃ§Ãµes passaram com sucesso:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Arquivos YAML validados" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Terraform verificado" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Workflows validados" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Scripts bash validados" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ PR pronto para merge!" >> $GITHUB_STEP_SUMMARY
