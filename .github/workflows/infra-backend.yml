name: Backend Terraform (S3 + DynamoDB)

on:
  push:
    branches: [main, feature/migracao_eks]
    paths:
      - 'infra/backend/**'
      - '.github/workflows/infra-backend.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.5.0

jobs:
  terraform:
    name: Criar Backend Terraform
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
      
      - name: Configurar Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Terraform Init (sem backend)
        working-directory: ./infra/backend
        run: terraform init
      
      - name: Verificar formataÃ§Ã£o Terraform
        working-directory: ./infra/backend
        run: terraform fmt -check
      
      - name: Validar Terraform
        working-directory: ./infra/backend
        run: terraform validate
      
      - name: Limpar recursos existentes para recriaÃ§Ã£o
        working-directory: ./infra/backend
        run: |
          echo "ğŸ§¹ Limpando recursos existentes para recriaÃ§Ã£o..."
          
          # Remove bucket S3 se existir
          if aws s3api head-bucket --bucket lanchonete-terraform-state 2>/dev/null; then
            echo "ğŸ—‘ï¸ Removendo bucket S3 existente..."
            # Esvazia o bucket primeiro
            aws s3 rm s3://lanchonete-terraform-state --recursive || true
            # Remove o bucket
            aws s3api delete-bucket --bucket lanchonete-terraform-state || true
            echo "âœ… Bucket S3 removido"
          fi
          
          # Remove tabela DynamoDB se existir
          if aws dynamodb describe-table --table-name lanchonete-terraform-locks 2>/dev/null; then
            echo "ğŸ—‘ï¸ Removendo tabela DynamoDB existente..."
            aws dynamodb delete-table --table-name lanchonete-terraform-locks || true
            
            # Aguarda a tabela ser deletada
            echo "â³ Aguardando remoÃ§Ã£o da tabela DynamoDB..."
            aws dynamodb wait table-not-exists --table-name lanchonete-terraform-locks || true
            echo "âœ… Tabela DynamoDB removida"
          fi
          
          echo "âœ… Limpeza concluÃ­da - recursos serÃ£o recriados"
      
      - name: Terraform Plan
        working-directory: ./infra/backend
        run: terraform plan -out=tfplan
      
      - name: Terraform Apply
        working-directory: ./infra/backend
        run: terraform apply -auto-approve tfplan
      
      - name: Salvar outputs
        working-directory: ./infra/backend
        run: |
          terraform output -json > backend-outputs.json
          cat backend-outputs.json
      
      - name: Upload outputs como artefato
        uses: actions/upload-artifact@v4
        with:
          name: backend-outputs
          path: infra/backend/backend-outputs.json
          retention-days: 7