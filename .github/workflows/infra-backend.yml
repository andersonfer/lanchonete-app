name: Backend Terraform (S3 + DynamoDB)

on:
  push:
    branches: [main, feature/migracao_eks]
    paths:
      - 'infra/backend/**'
      - '.github/workflows/infra-backend.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.5.0

jobs:
  terraform:
    name: Criar Backend Terraform
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout código
        uses: actions/checkout@v4
      
      - name: Configurar Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
      
      - name: Configurar credenciais AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: ${{ env.AWS_REGION }}
      
      - name: Terraform Init (sem backend)
        working-directory: ./infra/backend
        run: terraform init
      
      - name: Verificar formatação Terraform
        working-directory: ./infra/backend
        run: terraform fmt -check
      
      - name: Validar Terraform
        working-directory: ./infra/backend
        run: terraform validate
      
      - name: Verificar recursos existentes e importar se necessário
        working-directory: ./infra/backend
        run: |
          # Verifica se o bucket S3 já existe
          if aws s3api head-bucket --bucket lanchonete-terraform-state 2>/dev/null; then
            echo "✅ Bucket S3 já existe, importando recursos para o estado..."
            terraform import aws_s3_bucket.terraform_state lanchonete-terraform-state || true
            terraform import aws_s3_bucket_server_side_encryption_configuration.terraform_state lanchonete-terraform-state || true
            terraform import aws_s3_bucket_public_access_block.terraform_state lanchonete-terraform-state || true
          fi
          
          # Verifica se a tabela DynamoDB já existe
          if aws dynamodb describe-table --table-name lanchonete-terraform-locks 2>/dev/null; then
            echo "✅ Tabela DynamoDB já existe, importando para o estado..."
            terraform import aws_dynamodb_table.terraform_locks lanchonete-terraform-locks || true
          fi
      
      - name: Terraform Plan
        working-directory: ./infra/backend
        run: terraform plan -out=tfplan
      
      - name: Terraform Apply
        working-directory: ./infra/backend
        run: terraform apply -auto-approve tfplan
      
      - name: Salvar outputs
        working-directory: ./infra/backend
        run: |
          terraform output -json > backend-outputs.json
          cat backend-outputs.json
      
      - name: Upload outputs como artefato
        uses: actions/upload-artifact@v4
        with:
          name: backend-outputs
          path: infra/backend/backend-outputs.json
          retention-days: 7