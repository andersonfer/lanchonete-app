name: CI - Global Validations

on:
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'services/clientes/**'
      - 'services/pedidos/**'
      - 'services/cozinha/**'
      - 'services/pagamento/**'

jobs:
  validate:
    name: Testes e An√°lise SonarCloud
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verificar arquivos modificados
        id: changed-files
        run: |
          echo "üîç Analisando mudan√ßas no PR..."

          # Listar arquivos modificados
          git diff --name-only origin/main...HEAD > changed_files.txt

          echo "üìù Arquivos modificados:"
          cat changed_files.txt

          # Contar arquivos
          FILE_COUNT=$(wc -l < changed_files.txt)
          echo "total_files=$FILE_COUNT" >> $GITHUB_OUTPUT

          echo "‚úÖ Total de $FILE_COUNT arquivo(s) modificado(s)"

      - name: Verificar arquivos sens√≠veis
        run: |
          echo "üîê Verificando se h√° arquivos sens√≠veis..."

          # Lista de padr√µes de arquivos sens√≠veis que n√£o devem estar no repo
          SENSITIVE_PATTERNS=(
            "*.pem"
            "*.key"
            "*.p12"
            "*.jks"
            "*credentials*"
            "*.env"
            "*secret*"
            "*password*"
          )

          FOUND_SENSITIVE=false

          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            FILES=$(git diff --name-only origin/main...HEAD | grep -i "$pattern" || true)
            if [ -n "$FILES" ]; then
              echo "‚ö†Ô∏è  ATEN√á√ÉO: Arquivo potencialmente sens√≠vel encontrado: $FILES"
              FOUND_SENSITIVE=true
            fi
          done

          if [ "$FOUND_SENSITIVE" = true ]; then
            echo "‚ö†Ô∏è  Encontrados arquivos que podem conter informa√ß√µes sens√≠veis"
            echo "üí° Verifique se n√£o h√° credenciais, senhas ou chaves no c√≥digo"
            # N√£o falhar, apenas avisar
          else
            echo "‚úÖ Nenhum arquivo sens√≠vel detectado"
          fi

      - name: Verificar tamanho de arquivos
        run: |
          echo "üì¶ Verificando tamanho de arquivos..."

          # Verificar se h√° arquivos grandes (>5MB)
          LARGE_FILES=$(git diff --name-only origin/main...HEAD | while read file; do
            if [ -f "$file" ]; then
              SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
              if [ "$SIZE" -gt 5242880 ]; then
                echo "$file ($(numfmt --to=iec $SIZE 2>/dev/null || echo $SIZE bytes))"
              fi
            fi
          done)

          if [ -n "$LARGE_FILES" ]; then
            echo "‚ö†Ô∏è  Arquivos grandes detectados (>5MB):"
            echo "$LARGE_FILES"
            echo "üí° Considere usar Git LFS para arquivos bin√°rios grandes"
          else
            echo "‚úÖ Nenhum arquivo grande detectado"
          fi

      - name: Verificar merge conflicts
        run: |
          echo "üîÄ Verificando markers de merge conflict..."

          CONFLICT_FILES=$(git diff --name-only origin/main...HEAD | while read file; do
            if [ -f "$file" ]; then
              # Buscar por markers de conflict (usando vari√°veis para evitar falso positivo)
              MARKER1="<<<<<<< HEAD"
              MARKER2="======="
              MARKER3=">>>>>>>"
              if grep -l "$MARKER1\|$MARKER2\|$MARKER3" "$file" 2>/dev/null; then
                echo "$file"
              fi
            fi
          done)

          if [ -n "$CONFLICT_FILES" ]; then
            echo "‚ùå ERRO: Markers de merge conflict encontrados em:"
            echo "$CONFLICT_FILES"
            exit 1
          else
            echo "‚úÖ Nenhum marker de conflict detectado"
          fi

      - name: Resumo da valida√ß√£o
        if: always()
        run: |
          echo "## ‚úÖ Valida√ß√µes Globais - Resumo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìä Estat√≠sticas do PR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FILE_COUNT=$(git diff --name-only origin/main...HEAD | wc -l)
          COMMIT_COUNT=$(git log origin/main...HEAD --oneline | wc -l)

          echo "- üìù **Arquivos modificados:** $FILE_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- üîÑ **Commits:** $COMMIT_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ Valida√ß√µes Executadas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Verifica√ß√£o de arquivos sens√≠veis" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Verifica√ß√£o de tamanho de arquivos" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Verifica√ß√£o de merge conflicts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üéâ **PR pronto para revis√£o!**" >> $GITHUB_STEP_SUMMARY
