name: CI - Global Validations

on:
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'services/clientes/**'
      - 'services/pedidos/**'
      - 'services/cozinha/**'
      - 'services/pagamento/**'

jobs:
  validate:
    name: Testes e AnÃ¡lise SonarCloud
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Verificar arquivos modificados
        id: changed-files
        run: |
          echo "ğŸ” Analisando mudanÃ§as no PR..."

          # Listar arquivos modificados
          git diff --name-only origin/main...HEAD > changed_files.txt

          echo "ğŸ“ Arquivos modificados:"
          cat changed_files.txt

          # Contar arquivos
          FILE_COUNT=$(wc -l < changed_files.txt)
          echo "total_files=$FILE_COUNT" >> $GITHUB_OUTPUT

          echo "âœ… Total de $FILE_COUNT arquivo(s) modificado(s)"

      - name: Verificar arquivos sensÃ­veis
        run: |
          echo "ğŸ” Verificando se hÃ¡ arquivos sensÃ­veis..."

          # Lista de padrÃµes de arquivos sensÃ­veis que nÃ£o devem estar no repo
          SENSITIVE_PATTERNS=(
            "*.pem"
            "*.key"
            "*.p12"
            "*.jks"
            "*credentials*"
            "*.env"
            "*secret*"
            "*password*"
          )

          FOUND_SENSITIVE=false

          for pattern in "${SENSITIVE_PATTERNS[@]}"; do
            FILES=$(git diff --name-only origin/main...HEAD | grep -i "$pattern" || true)
            if [ -n "$FILES" ]; then
              echo "âš ï¸  ATENÃ‡ÃƒO: Arquivo potencialmente sensÃ­vel encontrado: $FILES"
              FOUND_SENSITIVE=true
            fi
          done

          if [ "$FOUND_SENSITIVE" = true ]; then
            echo "âš ï¸  Encontrados arquivos que podem conter informaÃ§Ãµes sensÃ­veis"
            echo "ğŸ’¡ Verifique se nÃ£o hÃ¡ credenciais, senhas ou chaves no cÃ³digo"
            # NÃ£o falhar, apenas avisar
          else
            echo "âœ… Nenhum arquivo sensÃ­vel detectado"
          fi

      - name: Verificar tamanho de arquivos
        run: |
          echo "ğŸ“¦ Verificando tamanho de arquivos..."

          # Verificar se hÃ¡ arquivos grandes (>5MB)
          LARGE_FILES=$(git diff --name-only origin/main...HEAD | while read file; do
            if [ -f "$file" ]; then
              SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
              if [ "$SIZE" -gt 5242880 ]; then
                echo "$file ($(numfmt --to=iec $SIZE 2>/dev/null || echo $SIZE bytes))"
              fi
            fi
          done)

          if [ -n "$LARGE_FILES" ]; then
            echo "âš ï¸  Arquivos grandes detectados (>5MB):"
            echo "$LARGE_FILES"
            echo "ğŸ’¡ Considere usar Git LFS para arquivos binÃ¡rios grandes"
          else
            echo "âœ… Nenhum arquivo grande detectado"
          fi

      - name: Verificar merge conflicts
        run: |
          echo "ğŸ”€ Verificando markers de merge conflict..."

          CONFLICT_FILES=$(git diff --name-only origin/main...HEAD | while read file; do
            if [ -f "$file" ]; then
              if grep -l "<<<<<<< HEAD\|=======" "$file" 2>/dev/null; then
                echo "$file"
              fi
            fi
          done)

          if [ -n "$CONFLICT_FILES" ]; then
            echo "âŒ ERRO: Markers de merge conflict encontrados em:"
            echo "$CONFLICT_FILES"
            exit 1
          else
            echo "âœ… Nenhum marker de conflict detectado"
          fi

      - name: Resumo da validaÃ§Ã£o
        if: always()
        run: |
          echo "## âœ… ValidaÃ§Ãµes Globais - Resumo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“Š EstatÃ­sticas do PR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          FILE_COUNT=$(git diff --name-only origin/main...HEAD | wc -l)
          COMMIT_COUNT=$(git log origin/main...HEAD --oneline | wc -l)

          echo "- ğŸ“ **Arquivos modificados:** $FILE_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ”„ **Commits:** $COMMIT_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… ValidaÃ§Ãµes Executadas" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… VerificaÃ§Ã£o de arquivos sensÃ­veis" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… VerificaÃ§Ã£o de tamanho de arquivos" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… VerificaÃ§Ã£o de merge conflicts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ‰ **PR pronto para revisÃ£o!**" >> $GITHUB_STEP_SUMMARY
