name: CD - Cozinha

on:
  push:
    branches: [main]
    paths:
      - 'services/cozinha/**'
      - '.github/workflows/cd-cozinha.yml'
      - 'k8s/aws/deployments/cozinha-deployment.yaml'
      - 'k8s/base/**/*cozinha*'

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: lanchonete-cozinha
  EKS_CLUSTER_NAME: lanchonete-cluster
  SERVICE_NAME: cozinha
  K8S_NAMESPACE: default

jobs:
  deploy:
    name: Build e Deploy
    runs-on: ubuntu-latest

    steps:
    # 1. CHECKOUT
    - name: Checkout cÃ³digo
      uses: actions/checkout@v4

    # 2. SETUP JAVA
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: maven

    # 3. BUILD
    - name: Build aplicaÃ§Ã£o
      run: |
        cd services/cozinha
        mvn clean package -DskipTests -q

    # 4. AWS CREDENTIALS
    - name: Configurar AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
        aws-region: ${{ env.AWS_REGION }}

    # 5. LOGIN ECR
    - name: Login no Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    # 6. BUILD E PUSH DOCKER (versionado com SHA)
    - name: Build e Push Docker
      working-directory: services/cozinha
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        IMAGE_URI=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        IMAGE_LATEST=$ECR_REGISTRY/$ECR_REPOSITORY:latest

        docker build -t $IMAGE_URI -t $IMAGE_LATEST .
        docker push $IMAGE_URI
        docker push $IMAGE_LATEST

        echo "âœ… Imagens publicadas:"
        echo "   - $IMAGE_URI"
        echo "   - $IMAGE_LATEST"

    # 7. CONFIGURAR KUBECTL
    - name: Configurar kubectl
      run: |
        aws eks update-kubeconfig \
          --region ${{ env.AWS_REGION }} \
          --name ${{ env.EKS_CLUSTER_NAME }}

    # 8. DEPLOY KUBERNETES
    - name: Deploy no EKS
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        # Aplicar ConfigMap
        kubectl apply -f k8s/base/configmaps/cozinha-configmap.yaml

        # Aplicar Service
        kubectl apply -f k8s/base/services/cozinha-service.yaml

        # Aplicar Deployment (substituir placeholder com tag SHA)
        sed "s|{{ECR_COZINHA}}|$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG|g" \
          k8s/aws/deployments/cozinha-deployment.yaml | kubectl apply -f -

        # Aplicar Ingress
        kubectl apply -f k8s/ingress/aws/cozinha-ingress.yaml

    # 9. AGUARDAR ROLLOUT
    - name: Aguardar deployment
      run: |
        kubectl rollout status deployment/cozinha-deployment \
          -n ${{ env.K8S_NAMESPACE }} \
          --timeout=5m

    # 10. SMOKE TESTS (Pod direto)
    - name: Smoke Tests
      run: |
        echo "â³ Aguardando pods ficarem prontos..."
        kubectl wait --for=condition=ready pod \
          -l app=cozinha \
          -n ${{ env.K8S_NAMESPACE }} \
          --timeout=300s

        POD_NAME=$(kubectl get pods -l app=cozinha -n ${{ env.K8S_NAMESPACE }} \
          -o jsonpath='{.items[0].metadata.name}')

        echo "ðŸ” Testando health endpoints no pod $POD_NAME..."

        # Health check
        kubectl exec $POD_NAME -n ${{ env.K8S_NAMESPACE }} -- \
          curl -sf http://localhost:8080/actuator/health || exit 1
        echo "âœ… Health check OK"

        # Readiness
        kubectl exec $POD_NAME -n ${{ env.K8S_NAMESPACE }} -- \
          curl -sf http://localhost:8080/actuator/health/readiness || exit 1
        echo "âœ… Readiness OK"

        # Liveness
        kubectl exec $POD_NAME -n ${{ env.K8S_NAMESPACE }} -- \
          curl -sf http://localhost:8080/actuator/health/liveness || exit 1
        echo "âœ… Liveness OK"

    # 11. VERIFICAR ALB (Opcional, nÃ£o bloqueia)
    - name: Verificar ALB
      if: always()
      run: |
        ALB_URL=$(kubectl get ingress cozinha-ingress -n ${{ env.K8S_NAMESPACE }} \
          -o jsonpath='{.status.loadBalancer.ingress[0].hostname}' 2>/dev/null || echo "")

        if [ -n "$ALB_URL" ]; then
          echo "âœ… ALB URL: http://$ALB_URL"
          echo ""
          echo "ðŸ” Testando ALB..."
          curl -sf "http://$ALB_URL/actuator/health" && echo "âœ… ALB respondendo!" || \
            echo "âš ï¸ ALB nÃ£o respondeu (pode estar inicializando)"
        else
          echo "â„¹ï¸ ALB ainda nÃ£o provisionado"
          echo "   Verifique manualmente: kubectl get ingress cozinha-ingress"
        fi

    # 12. RESUMO
    - name: Resumo do Deploy
      if: always()
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ github.sha }}
      run: |
        echo "## ðŸš€ Deploy Cozinha - Resumo" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ“¦ Imagens:**" >> $GITHUB_STEP_SUMMARY
        echo "- \`$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG\` (deployed)" >> $GITHUB_STEP_SUMMARY
        echo "- \`$ECR_REGISTRY/$ECR_REPOSITORY:latest\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**âš™ï¸ Kubernetes:**" >> $GITHUB_STEP_SUMMARY
        echo "- Cluster: \`$EKS_CLUSTER_NAME\`" >> $GITHUB_STEP_SUMMARY
        echo "- Namespace: \`$K8S_NAMESPACE\`" >> $GITHUB_STEP_SUMMARY
        echo "- Image Tag: \`${IMAGE_TAG:0:7}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**ðŸ“Š Status dos Pods:**" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        kubectl get pods -l app=cozinha -n $K8S_NAMESPACE >> $GITHUB_STEP_SUMMARY || true
        echo '```' >> $GITHUB_STEP_SUMMARY
